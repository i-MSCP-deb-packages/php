From c2e197e4efc663ca55f393bf0e799848842286f3 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sat, 1 Aug 2015 21:12:38 -0700
Subject: [PATCH] Fix bug #70168 - Use After Free Vulnerability in
 unserialize() with SplObjectStorage

---
 ext/spl/spl_observer.c |    2 ++
 1 file changed, 2 insertions(+)
 create mode 100644 ext/spl/tests/bug70168.phpt

--- a/ext/spl/spl_observer.c
+++ b/ext/spl/spl_observer.c
@@ -743,6 +743,7 @@ SPL_METHOD(SplObjectStorage, unserialize
 		goto outexcept;
 	}
 
+	var_push_dtor(&var_hash, &pcount);
 	--p; /* for ';' */
 	count = Z_LVAL_P(pcount);
 	zval_ptr_dtor(&pcount);
@@ -806,6 +807,7 @@ SPL_METHOD(SplObjectStorage, unserialize
 		goto outexcept;
 	}
 
+	var_push_dtor(&var_hash, &pmembers);
 	/* copy members */
 	zend_hash_copy(intern->std.properties, Z_ARRVAL_P(pmembers), (copy_ctor_func_t) zval_add_ref, (void *) NULL, sizeof(zval *));
 	zval_ptr_dtor(&pmembers);
