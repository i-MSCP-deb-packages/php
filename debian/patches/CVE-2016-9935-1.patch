

Backport of:

From 266ecb6d0a1ab5a37b4d652ca774a8adc4b06578 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Mon, 5 Dec 2016 21:40:55 -0800
Subject: [PATCH] Fix bug #73631 - Invalid read when wddx decodes empty boolean
 element

---
 ext/wddx/tests/bug73631.phpt |   19 +++++++++++++++++++
 ext/wddx/wddx.c              |    9 +++++++++
 2 files changed, 28 insertions(+)
 create mode 100644 ext/wddx/tests/bug73631.phpt

--- /dev/null
+++ b/ext/wddx/tests/bug73631.phpt
@@ -0,0 +1,19 @@
+--TEST--
+Bug #73631 (Memory leak due to invalid wddx stack processing)
+--SKIPIF--
+<?php if (!extension_loaded("wddx")) print "skip"; ?>
+--FILE--
+<?php
+$xml = <<<EOF
+<?xml version="1.0" ?>
+<wddxPacket version="1.0">
+<number>1234</number>
+<binary><boolean/></binary>
+</wddxPacket>
+EOF;
+$wddx = wddx_deserialize($xml);
+var_dump($wddx);
+?>
+--EXPECTF--
+int(1234)
+
--- a/ext/wddx/wddx.c
+++ b/ext/wddx/wddx.c
@@ -803,6 +803,15 @@ static void php_wddx_push_element(void *
 				php_wddx_process_data(user_data, atts[i+1], strlen(atts[i+1]));
 				break;
 			}
+		} else {
+			ent.type = ST_BOOLEAN;
+			SET_STACK_VARNAME;
+
+			ALLOC_ZVAL(ent.data);
+			INIT_PZVAL(ent.data);
+			Z_TYPE_P(ent.data) = IS_BOOL;
+			Z_LVAL_P(ent.data) = 0;
+			wddx_stack_push((wddx_stack *)stack, &ent, sizeof(st_entry));
 		}
 	} else if (!strcmp(name, EL_NULL)) {
 		ent.type = ST_NULL;
