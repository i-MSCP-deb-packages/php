Backport of:

From bf58162ddf970f63502837f366930e44d6a992cf Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sat, 4 Jul 2015 21:01:50 -0700
Subject: [PATCH] Fix bug #69958 - Segfault in Phar::convertToData on invalid
 file

---
 ext/phar/phar_object.c       |  70 ++++++++++++++++++++++---------------------
 ext/phar/tests/bug69958.phpt |  14 +++++++++
 ext/phar/tests/bug69958.tar  | Bin 0 -> 513 bytes
 ext/phar/phar_object.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)
 create mode 100644 ext/phar/tests/bug69958.phpt
 create mode 100644 ext/phar/tests/bug69958.tar

--- a/ext/phar/phar_object.c
+++ b/ext/phar/phar_object.c
@@ -2415,7 +2415,9 @@ no_copy:
 		zend_hash_destroy(&(phar->manifest));
 		zend_hash_destroy(&(phar->mounted_dirs));
 		zend_hash_destroy(&(phar->virtual_dirs));
-		php_stream_close(phar->fp);
+		if (phar->fp) {
+			php_stream_close(phar->fp);
+		}
 		efree(phar->fname);
 		efree(phar);
 		return NULL;
