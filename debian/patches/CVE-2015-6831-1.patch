Backport of:

From 7381b6accc5559b2de039af3a22f6ec1003b03b3 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sat, 1 Aug 2015 21:45:19 -0700
Subject: [PATCH] Fixed bug #70166 - Use After Free Vulnerability in
 unserialize() with SPLArrayObject

---
 ext/spl/spl_array.c         |    3 +++
 ext/spl/tests/bug70166.phpt |   29 +++++++++++++++++++++++++++++
 2 files changed, 32 insertions(+)
 create mode 100644 ext/spl/tests/bug70166.phpt

--- a/ext/spl/spl_array.c
+++ b/ext/spl/spl_array.c
@@ -1786,6 +1786,7 @@ void spl_array_unserialize_helper(spl_ar
 		goto outexcept;
 	}
 
+	var_push_dtor(var_hash_p, &pflags);
 	--p; /* for ';' */
 	flags = Z_LVAL_P(pflags);
 	zval_ptr_dtor(&pflags);
@@ -1810,6 +1811,7 @@ void spl_array_unserialize_helper(spl_ar
 		if (!php_var_unserialize(&intern->array, &p, s + buf_len, var_hash_p TSRMLS_CC)) {
 			goto outexcept;
 		}
+		var_push_dtor(var_hash_p, &intern->array);
 	}
 	if (*p != ';') {
 		goto outexcept;
@@ -1828,6 +1830,7 @@ void spl_array_unserialize_helper(spl_ar
 		goto outexcept;
 	}
 
+	var_push_dtor(var_hash_p, &pmembers);
 	/* copy members */
 	zend_hash_copy(intern->std.properties, Z_ARRVAL_P(pmembers), (copy_ctor_func_t) zval_add_ref, (void *) NULL, sizeof(zval *));
 	zval_ptr_dtor(&pmembers);
--- /dev/null
+++ b/ext/spl/tests/bug70166.phpt
@@ -0,0 +1,29 @@
+--TEST--
+SPL: Bug #70166 Use After Free Vulnerability in unserialize() with SPLArrayObject
+--FILE--
+<?php
+$inner = 'x:i:1;a:0:{};m:a:0:{}';
+$exploit = 'a:2:{i:0;C:11:"ArrayObject":'.strlen($inner).':{'.$inner.'}i:1;R:5;}';
+
+$data = unserialize($exploit);
+
+for($i = 0; $i < 5; $i++) {
+    $v[$i] = 'hi'.$i;
+}
+
+var_dump($data);
+?>
+===DONE===
+--EXPECTF--
+array(2) {
+  [0]=>
+  object(ArrayObject)#%d (1) {
+    ["storage":"ArrayObject":private]=>
+    array(0) {
+    }
+  }
+  [1]=>
+  array(0) {
+  }
+}
+===DONE===
