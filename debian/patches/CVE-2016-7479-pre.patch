Backport of:

From 13f1c276ab72cf1a8a400fd013b9289d0018a340 Mon Sep 17 00:00:00 2001
From: Anatol Belski <ab@php.net>
Date: Wed, 10 Dec 2014 11:43:33 +0100
Subject: [PATCH] Fixed bug #68545 NULL pointer dereference in unserialize.c

---
 ext/standard/var_unserializer.c        |    7 ++++++-
 ext/standard/var_unserializer.re       |    7 ++++++-
 standard/tests/serialize/bug68545.phpt |   11 +++++++++++
 3 files changed, 23 insertions(+), 2 deletions(-)
 create mode 100644 standard/tests/serialize/bug68545.phpt

--- a/ext/standard/var_unserializer.c
+++ b/ext/standard/var_unserializer.c
@@ -57,8 +57,13 @@ static inline void var_push(php_unserial
 
 PHPAPI void var_push_dtor(php_unserialize_data_t *var_hashx, zval **rval)
 {
-	var_entries *var_hash = var_hashx->first_dtor, *prev = NULL;
+	var_entries *var_hash, *prev = NULL;
 
+	if (!var_hashx) {
+		return;
+	}
+
+	var_hash = var_hashx->first_dtor;
 	while (var_hash && var_hash->used_slots == VAR_ENTRIES_MAX) {
 		prev = var_hash;
 		var_hash = var_hash->next;
--- a/ext/standard/var_unserializer.re
+++ b/ext/standard/var_unserializer.re
@@ -56,8 +56,13 @@ static inline void var_push(php_unserial
 
 PHPAPI void var_push_dtor(php_unserialize_data_t *var_hashx, zval **rval)
 {
-	var_entries *var_hash = var_hashx->first_dtor, *prev = NULL;
+	var_entries *var_hash, *prev = NULL;
 
+	if (!var_hashx) {
+		return;
+	}
+
+	var_hash = var_hashx->first_dtor;
 	while (var_hash && var_hash->used_slots == VAR_ENTRIES_MAX) {
 		prev = var_hash;
 		var_hash = var_hash->next;
--- /dev/null
+++ b/standard/tests/serialize/bug68545.phpt
@@ -0,0 +1,11 @@
+--TEST--
+Bug #68545 NULL pointer dereference in unserialize.c:var_push_dtor
+--FILE--
+<?php
+var_dump(unserialize('a:6:{a:6:{s:3:"322";s:3:"bar";s:3:"bar";s:3:"foo";a:6:{a:6:{s:3:"322";s:3:"bar";s:3:"bar";s:3:"foo";s:3:"bar";a:6:{a:6:{s:3:"322";s:3:"bar";s:3:"bar";s:3:"foo";a:6:{a:6:{s:3:"322";s:3:"bar";s:3:"b22";s:3:"bar";s:3:"bar";s:3:"foo";s:3:"bar";a:6:{a:6:{s:3:"322";s:3:"bar";s:3:"bar";s:3:"foo";s:3:"bar";s:3:"bar";'));
+?>
+===DONE===
+--EXPECTF--
+Notice: unserialize(): Error at offset %d of %d bytes in %sbug68545.php on line %d
+bool(false)
+===DONE===
