Backport of:

From 639f7fde6a51c23d7c670358fbcb777ac1a143f3 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 7 Aug 2016 15:33:29 -0700
Subject: [PATCH] Improve fix for #72663

---
 ext/standard/tests/strings/bug72663_3.phpt |   18 ++++++++++++++++++
 ext/standard/var_unserializer.c            |    8 +++++++-
 ext/standard/var_unserializer.re           |    8 +++++++-
 3 files changed, 32 insertions(+), 2 deletions(-)
 create mode 100644 ext/standard/tests/strings/bug72663_3.phpt

--- /dev/null
+++ b/ext/standard/tests/strings/bug72663_3.phpt
@@ -0,0 +1,18 @@
+--TEST--
+Bug #72663: Create an Unexpected Object and Don't Invoke __wakeup() in Deserialization
+--FILE--
+<?php
+class obj {
+	var $ryat;
+	function __wakeup() {
+		$this->ryat = str_repeat('A', 0x112);
+	}
+}
+
+$poc = 'O:8:"stdClass":1:{i:0;O:3:"obj":1:{s:4:"ryat";R:1;';
+unserialize($poc);
+?>
+DONE
+--EXPECTF--
+Notice: unserialize(): Error at offset 51 of 50 bytes in %sbug72663_3.php on line %d
+DONE
\ No newline at end of file
--- a/ext/standard/var_unserializer.c
+++ b/ext/standard/var_unserializer.c
@@ -399,11 +399,17 @@ static inline int object_common2(UNSERIA
 
 	if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {
 	    /* We've got partially constructed object on our hands here. Wipe it */
-	    zend_hash_clean(Z_OBJPROP_PP(rval));
+	    if(Z_TYPE_PP(rval) == IS_OBJECT) {
+	       zend_hash_clean(Z_OBJPROP_PP(rval));
+	    }
 	    ZVAL_NULL(*rval);
 		return 0;
 	}
 
+	if (Z_TYPE_PP(rval) != IS_OBJECT) {
+	    return 0;
+	}
+
 	if (Z_OBJCE_PP(rval) != PHP_IC_ENTRY &&
 		zend_hash_exists(&Z_OBJCE_PP(rval)->function_table, "__wakeup", sizeof("__wakeup"))) {
 		INIT_PZVAL(&fname);
--- a/ext/standard/var_unserializer.re
+++ b/ext/standard/var_unserializer.re
@@ -405,11 +405,17 @@ static inline int object_common2(UNSERIA
 
 	if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {
 	    /* We've got partially constructed object on our hands here. Wipe it. */
-	    zend_hash_clean(Z_OBJPROP_PP(rval));
+	    if(Z_TYPE_PP(rval) == IS_OBJECT) {
+	       zend_hash_clean(Z_OBJPROP_PP(rval));
+	    }
 	    ZVAL_NULL(*rval);
 		return 0;
 	}
 
+    if (Z_TYPE_PP(rval) != IS_OBJECT) {
+        return 0;
+    }
+
 	if (Z_OBJCE_PP(rval) != PHP_IC_ENTRY &&
 		zend_hash_exists(&Z_OBJCE_PP(rval)->function_table, "__wakeup", sizeof("__wakeup"))) {
 		INIT_PZVAL(&fname);
