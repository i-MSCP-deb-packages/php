From 448c9be157f4147e121f1a2a524536c75c9c6059 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Tue, 2 Aug 2016 01:08:42 -0700
Subject: [PATCH] Fix bug #72663 - destroy broken object when unserializing

---
 ext/standard/var_unserializer.c  |    3 +++
 ext/standard/var_unserializer.re |    3 +++
 2 files changed, 6 insertions(+)
 create mode 100644 ext/standard/tests/strings/bug72663.phpt
 create mode 100644 ext/standard/tests/strings/bug72663_2.phpt

--- a/ext/standard/var_unserializer.c
+++ b/ext/standard/var_unserializer.c
@@ -398,6 +398,9 @@ static inline int object_common2(UNSERIA
 	zval fname;
 
 	if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {
+	    /* We've got partially constructed object on our hands here. Wipe it */
+	    zend_hash_clean(Z_OBJPROP_PP(rval));
+	    ZVAL_NULL(*rval);
 		return 0;
 	}
 
--- a/ext/standard/var_unserializer.re
+++ b/ext/standard/var_unserializer.re
@@ -404,6 +404,9 @@ static inline int object_common2(UNSERIA
 	zval fname;
 
 	if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {
+	    /* We've got partially constructed object on our hands here. Wipe it. */
+	    zend_hash_clean(Z_OBJPROP_PP(rval));
+	    ZVAL_NULL(*rval);
 		return 0;
 	}
 
