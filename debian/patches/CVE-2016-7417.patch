Backport of:

From ecb7f58a069be0dec4a6131b6351a761f808f22e Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 11 Sep 2016 20:24:13 -0700
Subject: [PATCH] Fix bug #73029 - Missing type check when unserializing
 SplArray

---
 ext/spl/spl_array.c |   18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)
 create mode 100644 ext/spl/tests/bug73029.phpt

--- a/ext/spl/spl_array.c
+++ b/ext/spl/spl_array.c
@@ -312,10 +312,10 @@ static zval **spl_array_get_dimension_pt
 	long index;
 	HashTable *ht = spl_array_get_hash_table(intern, 0 TSRMLS_CC);
 
-	if (!offset) {
+	if (!offset || !ht) {
 		return &EG(uninitialized_zval_ptr);
 	}
-	
+
 	if ((type == BP_VAR_W || type == BP_VAR_RW) && (ht->nApplyCount > 0)) {
 		zend_error(E_WARNING, "Modification of ArrayObject during sorting is prohibited");
 		return &EG(error_zval_ptr);;
@@ -347,8 +347,8 @@ static zval **spl_array_get_dimension_pt
 	case IS_RESOURCE:
 		zend_error(E_STRICT, "Resource ID#%ld used as offset, casting to integer (%ld)", Z_LVAL_P(offset), Z_LVAL_P(offset));
 	case IS_DOUBLE:
-	case IS_BOOL: 
-	case IS_LONG: 
+	case IS_BOOL:
+	case IS_LONG:
 		if (offset->type == IS_DOUBLE) {
 			index = (long)Z_DVAL_P(offset);
 		} else {
@@ -587,7 +587,7 @@ static int spl_array_has_dimension_ex(in
 		}
 		return 0;
 	}
-	
+
 	switch(Z_TYPE_P(offset)) {
 		case IS_STRING:
 			{
@@ -606,8 +606,8 @@ static int spl_array_has_dimension_ex(in
 			}
 		case IS_DOUBLE:
 		case IS_RESOURCE:
-		case IS_BOOL: 
-		case IS_LONG: 
+		case IS_BOOL:
+		case IS_LONG:
 			{
 				HashTable *ht = spl_array_get_hash_table(intern, 0 TSRMLS_CC);
 				if (offset->type == IS_DOUBLE) {
@@ -1806,7 +1806,9 @@ void spl_array_unserialize_helper(spl_ar
 		intern->ar_flags |= flags & SPL_ARRAY_CLONE_MASK;
 		zval_ptr_dtor(&intern->array);
 		ALLOC_INIT_ZVAL(intern->array);
-		if (!php_var_unserialize(&intern->array, &p, s + buf_len, var_hash_p TSRMLS_CC)) {
+		if (!php_var_unserialize(&intern->array, &p, s + buf_len, var_hash_p TSRMLS_CC)
+				|| (Z_TYPE_P(intern->array) != IS_ARRAY && Z_TYPE_P(intern->array) != IS_OBJECT)) {
+			zval_ptr_dtor(&intern->array);
 			goto outexcept;
 		}
 		var_push_dtor(var_hash_p, &intern->array);
