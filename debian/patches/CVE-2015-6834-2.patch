From f06a069c462d37c2e009f6d1d93b8c8e7b713393 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Tue, 1 Sep 2015 00:14:15 -0700
Subject: [PATCH] Fix bug #70365 - use-after-free vulnerability in
 unserialize() with SplObjectStorage

---
 ext/spl/spl_observer.c |    2 ++
 1 file changed, 2 insertions(+)
 create mode 100644 ext/spl/tests/bug70365.phpt

--- a/ext/spl/spl_observer.c
+++ b/ext/spl/spl_observer.c
@@ -763,6 +763,7 @@ SPL_METHOD(SplObjectStorage, unserialize
 			zval_ptr_dtor(&pentry);
 			goto outexcept;
 		}
+		var_push_dtor(&var_hash, &pentry);
 		if(Z_TYPE_P(pentry) != IS_OBJECT) {
 			zval_ptr_dtor(&pentry);
 			goto outexcept;
@@ -774,6 +775,7 @@ SPL_METHOD(SplObjectStorage, unserialize
 				zval_ptr_dtor(&pinf);
 				goto outexcept;
 			}
+			var_push_dtor(&var_hash, &pinf);
 		}
 		
 		pelement = spl_object_storage_get(intern, pentry TSRMLS_CC);
